<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.7" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.23" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html"><meta property="og:site_name" content="博客演示"><meta property="og:title" content="第 12 章：条形码识别"><meta property="og:description" content="第 12 章：条形码识别 本章我们将用第十章开发的图像分析库来制作一个条形码识别应用。只要用手机的摄像头拍下书的封底，我们就能用这个程序来提取这本书的ISBN编号。 条形码简介 市售绝大多数带有外包装的量产消费品上都有一个条形码。尽管有很多种不同的条形码系统在多个专业领域中被使用，但是在消费品中最典型的条形码系统还是UPC-A和EAN-13两种。UPC..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-02-25T04:54:45.000Z"><meta property="article:author" content="hahg"><meta property="article:modified_time" content="2024-02-25T04:54:45.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"第 12 章：条形码识别","image":[""],"dateModified":"2024-02-25T04:54:45.000Z","author":[{"@type":"Person","name":"hahg"}]}</script><title>第 12 章：条形码识别 | 博客演示</title><meta name="description" content="第 12 章：条形码识别 本章我们将用第十章开发的图像分析库来制作一个条形码识别应用。只要用手机的摄像头拍下书的封底，我们就能用这个程序来提取这本书的ISBN编号。 条形码简介 市售绝大多数带有外包装的量产消费品上都有一个条形码。尽管有很多种不同的条形码系统在多个专业领域中被使用，但是在消费品中最典型的条形码系统还是UPC-A和EAN-13两种。UPC...">
    <link rel="preload" href="/assets/style-kgjWb58-.css" as="style"><link rel="stylesheet" href="/assets/style-kgjWb58-.css">
    <link rel="modulepreload" href="/assets/app-Chw2KLnS.js"><link rel="modulepreload" href="/assets/12-1.html-D_88MDr6.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-D-4333g_.js" as="script"><link rel="prefetch" href="/assets/intro.html-BW3v88yc.js" as="script"><link rel="prefetch" href="/assets/index.html-CCzvQrWt.js" as="script"><link rel="prefetch" href="/assets/disable.html-B3LxCBxh.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-usFtQVss.js" as="script"><link rel="prefetch" href="/assets/layout.html-JcTV-DB0.js" as="script"><link rel="prefetch" href="/assets/markdown.html-DV77HWLq.js" as="script"><link rel="prefetch" href="/assets/page.html-6GRX-Ieq.js" as="script"><link rel="prefetch" href="/assets/cherry.html-rSagyIje.js" as="script"><link rel="prefetch" href="/assets/dragonfruit.html-BBDKfm44.js" as="script"><link rel="prefetch" href="/assets/strawberry.html-BkjUi3OZ.js" as="script"><link rel="prefetch" href="/assets/tomato.html-Et4aoQ3M.js" as="script"><link rel="prefetch" href="/assets/1.html-CDx9MaoB.js" as="script"><link rel="prefetch" href="/assets/2.html-l8teR3Xh.js" as="script"><link rel="prefetch" href="/assets/3.html-BnTuYZwF.js" as="script"><link rel="prefetch" href="/assets/4.html-blZzWWm0.js" as="script"><link rel="prefetch" href="/assets/1.html-Cecp1D8W.js" as="script"><link rel="prefetch" href="/assets/2.html-DZnWmgqa.js" as="script"><link rel="prefetch" href="/assets/3.html-DUqgmkJE.js" as="script"><link rel="prefetch" href="/assets/4.html-B0f_9QRw.js" as="script"><link rel="prefetch" href="/assets/1.html-Bn3aZ8DM.js" as="script"><link rel="prefetch" href="/assets/10.html-C7u8QqEM.js" as="script"><link rel="prefetch" href="/assets/11.html-DeoV8c69.js" as="script"><link rel="prefetch" href="/assets/12-2.html-47m8ef6e.js" as="script"><link rel="prefetch" href="/assets/13.html-7KpsJFDO.js" as="script"><link rel="prefetch" href="/assets/14.html-sDwJu6rk.js" as="script"><link rel="prefetch" href="/assets/16.html-aJZHLtmd.js" as="script"><link rel="prefetch" href="/assets/18.html-DSyxcTqB.js" as="script"><link rel="prefetch" href="/assets/19.html-BZFZdYcn.js" as="script"><link rel="prefetch" href="/assets/2.html-CVpywZBV.js" as="script"><link rel="prefetch" href="/assets/20.html-C_CD1ziP.js" as="script"><link rel="prefetch" href="/assets/3.html-CERXcBXe.js" as="script"><link rel="prefetch" href="/assets/4.html-D9cayysz.js" as="script"><link rel="prefetch" href="/assets/5.html-CeHIu5OV.js" as="script"><link rel="prefetch" href="/assets/6.html-3HzzJ2Zz.js" as="script"><link rel="prefetch" href="/assets/7.html-Dv855PbD.js" as="script"><link rel="prefetch" href="/assets/8.html-D-kf4ZMy.js" as="script"><link rel="prefetch" href="/assets/9.html-D8e2xhZ4.js" as="script"><link rel="prefetch" href="/assets/index.html-CAjikkuZ.js" as="script"><link rel="prefetch" href="/assets/重学CSS-上.html-BUQIK-cH.js" as="script"><link rel="prefetch" href="/assets/重学CSS-中.html-Bqci3Tkb.js" as="script"><link rel="prefetch" href="/assets/重学HTML-上.html-CAkUzXMr.js" as="script"><link rel="prefetch" href="/assets/重学HTML-下.html-rsUp7lR7.js" as="script"><link rel="prefetch" href="/assets/错题一.html-CYeGLBHa.js" as="script"><link rel="prefetch" href="/assets/面试题一.html-D5VyX_0T.js" as="script"><link rel="prefetch" href="/assets/SQL速记.html-DIXxb7kl.js" as="script"><link rel="prefetch" href="/assets/Git学习.html-87VYegNQ.js" as="script"><link rel="prefetch" href="/assets/编程规范.html-CW39F6t_.js" as="script"><link rel="prefetch" href="/assets/index.html-xdM8EHCo.js" as="script"><link rel="prefetch" href="/assets/算法一-6月24.html-CHCRNWQy.js" as="script"><link rel="prefetch" href="/assets/算法七.html-DPyLeQk8.js" as="script"><link rel="prefetch" href="/assets/算法三-7月28.html-B0HAMHw7.js" as="script"><link rel="prefetch" href="/assets/算法二-7月11.html-JsuFmA6P.js" as="script"><link rel="prefetch" href="/assets/算法五-8月28.html-D71yr5mU.js" as="script"><link rel="prefetch" href="/assets/算法六-10月3.html-BFRega6l.js" as="script"><link rel="prefetch" href="/assets/算法四-8月11-动态规划合集.html-B7HP_z34.js" as="script"><link rel="prefetch" href="/assets/Vue-上.html-CHGfU6Ov.js" as="script"><link rel="prefetch" href="/assets/Vue-下之源码分析.html-B4BOMGlR.js" as="script"><link rel="prefetch" href="/assets/Vue-中之项目开发.html-BNKjB66r.js" as="script"><link rel="prefetch" href="/assets/jQuery-上.html-BQo6gt90.js" as="script"><link rel="prefetch" href="/assets/jQuery-下.html-CnxgA8ZG.js" as="script"><link rel="prefetch" href="/assets/jQuery-中.html-B35MupEG.js" as="script"><link rel="prefetch" href="/assets/ES6-上.html-DQYUI9hP.js" as="script"><link rel="prefetch" href="/assets/ES6-中.html-DaXVyDBh.js" as="script"><link rel="prefetch" href="/assets/原生JS-下.html-xr5zey39.js" as="script"><link rel="prefetch" href="/assets/原生JS高级-上.html-o-qPI0Gw.js" as="script"><link rel="prefetch" href="/assets/原生JS高级-中.html-CzlCX0C1.js" as="script"><link rel="prefetch" href="/assets/Node-上之基本知识.html-B-ZrL6Mv.js" as="script"><link rel="prefetch" href="/assets/Node-下之综合Web项目.html-CC8zlLP7.js" as="script"><link rel="prefetch" href="/assets/Node-中之框架使用.html-BcECM_rl.js" as="script"><link rel="prefetch" href="/assets/一、入门.html-VUgtmP9p.js" as="script"><link rel="prefetch" href="/assets/一、MyBatis入门.html-Byhknz0g.js" as="script"><link rel="prefetch" href="/assets/二、单表的 CURD 操作.html-DyN9eey7.js" as="script"><link rel="prefetch" href="/assets/五、Mybatis注解式开发.html-C1h3c7J6.js" as="script"><link rel="prefetch" href="/assets/四、查询缓存.html-gzd-Xqbd.js" as="script"><link rel="prefetch" href="/assets/一、SSM框架前言-系统架构.html-B7fDCYsi.js" as="script"><link rel="prefetch" href="/assets/三、SSM框架前言-代理模式.html-Bw9gjUVx.js" as="script"><link rel="prefetch" href="/assets/五、SSM框架前言-模板方法设计模式.html-DHn5bpes.js" as="script"><link rel="prefetch" href="/assets/六、JUnit测试.html-Dm722NS2.js" as="script"><link rel="prefetch" href="/assets/一、Spring概述.html-CtM1sJKs.js" as="script"><link rel="prefetch" href="/assets/三、Spring与AOP.html-m8tQq9V1.js" as="script"><link rel="prefetch" href="/assets/二、Spring与IoC.html-CuDnS1dn.js" as="script"><link rel="prefetch" href="/assets/五、Spring与MyBatis.html-DULQBmJl.js" as="script"><link rel="prefetch" href="/assets/六、Spring与Web.html-B1a5iSLq.js" as="script"><link rel="prefetch" href="/assets/一、SpringMVC概述.html-BXm9kL0V.js" as="script"><link rel="prefetch" href="/assets/三、SpringMVC注解式开发.html-C-aYCX5-.js" as="script"><link rel="prefetch" href="/assets/二、SpringMVC配置式开发.html-BFuJuuMN.js" as="script"><link rel="prefetch" href="/assets/404.html-MgJ0QEs8.js" as="script"><link rel="prefetch" href="/assets/index.html-BGzazsmI.js" as="script"><link rel="prefetch" href="/assets/index.html-DYswqIrx.js" as="script"><link rel="prefetch" href="/assets/index.html-DSM4F059.js" as="script"><link rel="prefetch" href="/assets/index.html-17WQrSGB.js" as="script"><link rel="prefetch" href="/assets/index.html-CeX6q_bm.js" as="script"><link rel="prefetch" href="/assets/index.html-DffiFuCR.js" as="script"><link rel="prefetch" href="/assets/index.html-B--6UzOZ.js" as="script"><link rel="prefetch" href="/assets/index.html-CrTiSuQ7.js" as="script"><link rel="prefetch" href="/assets/index.html-BReSrJsw.js" as="script"><link rel="prefetch" href="/assets/index.html-C6xK3nPo.js" as="script"><link rel="prefetch" href="/assets/index.html-BjBdy9OO.js" as="script"><link rel="prefetch" href="/assets/index.html-CqvNhq7f.js" as="script"><link rel="prefetch" href="/assets/index.html-CAMDhNfE.js" as="script"><link rel="prefetch" href="/assets/index.html-C9aeeKmO.js" as="script"><link rel="prefetch" href="/assets/index.html-uUqlu4aT.js" as="script"><link rel="prefetch" href="/assets/index.html-DhqSxcFk.js" as="script"><link rel="prefetch" href="/assets/index.html-I3XfMlES.js" as="script"><link rel="prefetch" href="/assets/index.html-7ikIuZTD.js" as="script"><link rel="prefetch" href="/assets/index.html-3c6b-Y2B.js" as="script"><link rel="prefetch" href="/assets/index.html-swJI4354.js" as="script"><link rel="prefetch" href="/assets/index.html-DLtI5QxB.js" as="script"><link rel="prefetch" href="/assets/index.html-B5sImYeg.js" as="script"><link rel="prefetch" href="/assets/index.html-Cdjd08yv.js" as="script"><link rel="prefetch" href="/assets/index.html-uD61HD68.js" as="script"><link rel="prefetch" href="/assets/index.html-DHI1o5HF.js" as="script"><link rel="prefetch" href="/assets/index.html-Cdublov3.js" as="script"><link rel="prefetch" href="/assets/index.html-DiR05JqH.js" as="script"><link rel="prefetch" href="/assets/index.html-C8_3DHu4.js" as="script"><link rel="prefetch" href="/assets/index.html-D_ck-fuL.js" as="script"><link rel="prefetch" href="/assets/index.html-mSQ3NMXy.js" as="script"><link rel="prefetch" href="/assets/index.html-_Qb1lsdR.js" as="script"><link rel="prefetch" href="/assets/index.html-DGWJ4W1Y.js" as="script"><link rel="prefetch" href="/assets/index.html-n41l4Ot4.js" as="script"><link rel="prefetch" href="/assets/index.html-BBMcKcRg.js" as="script"><link rel="prefetch" href="/assets/index.html-zyL2EnzF.js" as="script"><link rel="prefetch" href="/assets/index.html-Cwi8cA9t.js" as="script"><link rel="prefetch" href="/assets/index.html-n4znuEHn.js" as="script"><link rel="prefetch" href="/assets/index.html-DXChDfLd.js" as="script"><link rel="prefetch" href="/assets/index.html-D8zMbI9p.js" as="script"><link rel="prefetch" href="/assets/index.html-OtNIaLb6.js" as="script"><link rel="prefetch" href="/assets/index.html-CJ4cvqBK.js" as="script"><link rel="prefetch" href="/assets/index.html-D2wOD0a3.js" as="script"><link rel="prefetch" href="/assets/index.html-BtYyOFDL.js" as="script"><link rel="prefetch" href="/assets/index.html-bCxqST6l.js" as="script"><link rel="prefetch" href="/assets/index.html-C6m-9gxj.js" as="script"><link rel="prefetch" href="/assets/index.html-usbu1vM_.js" as="script"><link rel="prefetch" href="/assets/index.html-BCfWa0Fp.js" as="script"><link rel="prefetch" href="/assets/index-uOBkQLRT.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">博客演示</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="博客主页"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/%E5%AD%A6%E4%B9%A0/" aria-label="学习"><span class="font-icon icon fa-fw fa-sm fas fa-creative" style=""></span>学习<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://vuepress-theme-hope.github.io/v2/zh/" rel="noopener noreferrer" target="_blank" aria-label="关于我" class="nav-link"><span class="font-icon icon fa-fw fa-sm fas fa-light" style=""></span>关于我<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/timeline/" aria-label="时间轴"><span class="font-icon icon fa-fw fa-sm fas fa-time" style=""></span>时间轴<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://vuepress-theme-hope.github.io/v2/zh/" rel="noopener noreferrer" target="_blank" aria-label="常用链接" class="nav-link"><span class="font-icon icon fa-fw fa-sm fas fa-network" style=""></span>常用链接<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">Haskell中文文档</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-2.html" aria-label="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-2.html"><!---->/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-2.html<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/1.html" aria-label="第 1 章：入门"><!---->第 1 章：入门<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/2.html" aria-label="第 2 章：类型和函数"><!---->第 2 章：类型和函数<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/3.html" aria-label="第 3 章：定义类型并简化函数"><!---->第 3 章：定义类型并简化函数<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/4.html" aria-label="第 4 章：函数式编程"><!---->第 4 章：函数式编程<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/5.html" aria-label="第 5 章：编写 JSON 库"><!---->第 5 章：编写 JSON 库<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/6.html" aria-label="第 6 章：使用类型类"><!---->第 6 章：使用类型类<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/7.html" aria-label="第 7 章：I/O"><!---->第 7 章：I/O<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/8.html" aria-label="第 8 章：高效文件处理、正则表达式、文件名匹配"><!---->第 8 章：高效文件处理、正则表达式、文件名匹配<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/9.html" aria-label="第 9 章：I/O学习 —— 构建一个用于搜索文件系统的库"><!---->第 9 章：I/O学习 —— 构建一个用于搜索文件系统的库<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/10.html" aria-label="第 10 章：代码案例学习：解析二进制数据格式"><!---->第 10 章：代码案例学习：解析二进制数据格式<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/11.html" aria-label="第 11 章：测试和质量保障"><!---->第 11 章：测试和质量保障<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html" aria-label="第 12 章：条形码识别"><!---->第 12 章：条形码识别<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#a-little-bit-about-barcodes" aria-label="条形码简介"><!---->条形码简介<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#ean-13-encoding" aria-label="EAN-13编码"><!---->EAN-13编码<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#introducing-arrays" aria-label="引入数组"><!---->引入数组<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#arrays-and-laziness" aria-label="数组与惰性"><!---->数组与惰性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#folding-over-arrays" aria-label="数组的折叠"><!---->数组的折叠<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#modifying-array-elements" aria-label="修改数组元素"><!---->修改数组元素<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#习题" aria-label="习题"><!---->习题<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#encoding-an-ean-13-barcode" aria-label="生成EAN-13条形码"><!---->生成EAN-13条形码<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#对解码器的约束" aria-label="对解码器的约束"><!---->对解码器的约束<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#divide-and-conquer" aria-label="分而治之"><!---->分而治之<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#turning-a-colour-image-into-something-tractable" aria-label="将彩色图像转换为更容易处理的形式"><!---->将彩色图像转换为更容易处理的形式<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#parsing-a-colour-image" aria-label="分析彩色图像"><!---->分析彩色图像<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#greyscale-conversion" aria-label="灰度转换"><!---->灰度转换<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#greyscale-to-binary-and-type-safety" aria-label="灰度二值化和类型安全"><!---->灰度二值化和类型安全<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/12-1.html#what-have-we-done-to-our-image" aria-label="我们对图像做了哪些处理？"><!---->我们对图像做了哪些处理？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/13.html" aria-label="第 13 章：数据结构"><!---->第 13 章：数据结构<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/14.html" aria-label="第 14 章：Monads"><!---->第 14 章：Monads<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/16.html" aria-label="第 16 章：使用Parsec"><!---->第 16 章：使用Parsec<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/18.html" aria-label="第 18 章： Monad变换器"><!---->第 18 章： Monad变换器<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/19.html" aria-label="第 19 章： 错误处理"><!---->第 19 章： 错误处理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/20.html" aria-label="第 20 章：使用 Haskell 进行系统编程"><!---->第 20 章：使用 Haskell 进行系统编程<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">前端</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">后端</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">工具</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">算法</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->第 12 章：条形码识别</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">hahg</span></span><span property="author" content="hahg"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-02-25T04:39:03.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#a-little-bit-about-barcodes">条形码简介</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#ean-13-encoding">EAN-13编码</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#introducing-arrays">引入数组</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#arrays-and-laziness">数组与惰性</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#folding-over-arrays">数组的折叠</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#modifying-array-elements">修改数组元素</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#习题">习题</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#encoding-an-ean-13-barcode">生成EAN-13条形码</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#对解码器的约束">对解码器的约束</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#divide-and-conquer">分而治之</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#turning-a-colour-image-into-something-tractable">将彩色图像转换为更容易处理的形式</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#parsing-a-colour-image">分析彩色图像</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#greyscale-conversion">灰度转换</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#greyscale-to-binary-and-type-safety">灰度二值化和类型安全</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#what-have-we-done-to-our-image">我们对图像做了哪些处理？</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="barcode-recongnition" tabindex="-1"><a class="header-anchor" href="#barcode-recongnition"><span>第 12 章：条形码识别</span></a></h1><p>本章我们将用第十章开发的图像分析库来制作一个条形码识别应用。只要用手机的摄像头拍下书的封底，我们就能用这个程序来提取这本书的ISBN编号。</p><h2 id="a-little-bit-about-barcodes" tabindex="-1"><a class="header-anchor" href="#a-little-bit-about-barcodes"><span>条形码简介</span></a></h2><p>市售绝大多数带有外包装的量产消费品上都有一个条形码。尽管有很多种不同的条形码系统在多个专业领域中被使用，但是在消费品中最典型的条形码系统还是UPC-A和EAN-13两种。UPC-A由美国开发，而EAN-13最初由欧洲开发。</p><p>EAN-13发表于UPC-A之后，它是UPC-A的超集。（事实上，尽管UPC-A现在在美国依然被广泛使用，但该标准早在在2005年已经被官方宣布作废了。)任何可以识别EAN-13条形码的硬件都可以兼容UPC-A条形码。这样我们只介绍EAN-13一种标准就可以了。</p><p>正如其名字所暗示的，EAN-13描述了一个由13个数字组成的序列，该序列可以分为四组：</p><ul><li>最前的两个数字描述了条形码采用的 <em>码制</em> 。这两位数字可以标识生产商所在国家，或者描述该条码的类别，比方说ISBN(国际标准书号)。</li></ul><p>[译注1：确切的讲，此处的&quot;生产商所在国&quot;实际上是指&quot;为该生产商分配生产商代码的编码管理局所属国家&quot;]</p><p>[译注2：事实上，码制的长度可能为两位甚至更多位，但目前GS1 General Specifications中给出的最长的码制也只有3位。例如某条形码的类别是ISBN码的话，那么它的码制部分应该为978(后文中给出的实际图中也可以看到)；如果类别是ISSN(International Standard Serial Number，国际标准连续出版物号)，则码制为977。其他部分的长度也比本章介绍的要更有弹性，但这些差异并不会影响对本章内容的理解。事实上，这一部分的内容在本章后面的内容中也完全用不到，因为我们在从条码的图形中提取出数字序列后，并没有进一步分离出各个分组乃至查询每个分组表示的具体信息。]</p><ul><li>接下来的五个数字为厂商代码，由各国的编码规范机构分配。</li><li>再接下来的5个数字是产品代码，由生产厂商决定。(规模较小的生产商可能会使用较长的生产商ID和较短的产品ID，但是两个ID加起总是10个数字。)</li><li>最后一个数字为 <em>校验码(check digit)</em> ，扫描设备可以通过它来校验扫描到的数字串。</li></ul><p>EAN-13条形码与UPC-A条形码的唯一不同在于后者只用一位数字表示码制。EAN-13条形码通过将码制的第一位数字置零实现对UPC-A的兼容。</p><h3 id="ean-13-encoding" tabindex="-1"><a class="header-anchor" href="#ean-13-encoding"><span>EAN-13编码</span></a></h3><p>在考虑怎样解码EAN-13条形码之前，我们还是得先了解它是怎样被编码出来的。EAN-13的编码规则有一点复杂。我们先从计算校验码------即数字串的最后一位开始。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token hvariable">checkDigit</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Integral</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span>
<span class="token hvariable">checkDigit</span> <span class="token hvariable">ds</span> <span class="token operator">=</span> <span class="token hvariable">productSum</span> <span class="token operator">`mod`</span> <span class="token number">10</span> <span class="token operator">`mod`</span> <span class="token number">10</span>
    <span class="token keyword">where</span> <span class="token hvariable">productSum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token hvariable">products</span> <span class="token punctuation">(</span><span class="token hvariable">mapEveryOther</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">reverse</span> <span class="token hvariable">ds</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">mapEveryOther</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span>
<span class="token hvariable">mapEveryOther</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token builtin">zipWith</span> <span class="token punctuation">(</span><span class="token operator">$</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">cycle</span> <span class="token punctuation">[</span><span class="token hvariable">f</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>[译注1：原文对checkDigit函数的实现有问题，翻译时用了比较直接的方法修正了代码，并相应的修改了下面一段正文中对代码的描述]</p><p>[译注2：你可能觉得如果把 <code>mapEveryOther</code> 中的 <code>f</code> 和 <code>id</code> 两个列表元素的位置对调的话，就可以省略掉 <code>checkDigit</code> 的where块中的 <code>reverse</code> 过程。事实上这个reverse过程是必须的，而且 <code>f</code> 和 <code>id</code> 也不能对调。因为EAN-13的标准规定，&quot;将序列中的最右侧的数字规定为 <code>奇数位</code>，从最右侧开始，其余数字被交替记为 <code>偶数位</code> 和 <code>奇数位</code>，而只有奇数位的数字会被乘以3。如果采取最开始说的方法，那么假如输入的序列包含偶数个元素的话，那么整个计算过程就是错误的。这一点的重要性在后文会有体现。]</p><p>直接看代码应该比文字描述更有助于理解校验码的计算方法。函数从数字串的最右一位数字开始，每隔一位就将该数字乘以3，其余保持原状。接下来对处理后的列表求和，校验码就是将这个列表的和对10取模两次得到的结果。</p><p>条形码是一系列定宽的条纹，其中黑色的条纹表示二进制的&quot;1&quot;，白色的条纹表示二进制的&quot;0&quot;。表示相同二进制的条纹值连续排列看起来就是宽一些的条纹。</p><p>条形码中的各个二进制位的顺序如下：</p><ul><li>头部保护序列，固定编码101。</li><li>一个由六个数字组成的分组，其中每个数字由7个二进制位表示</li><li>另一个保护序列，固定编码01010</li><li>另一个六个数字的组成的分组 (译注：每个数字也由7个二进制位表示)</li><li>尾部保护序列，固定编码101</li></ul><p>左右两个分组中的数字有不同的编码。左侧分组的数字编码包含了校验位(parity bit)，而校验位编码了条形码的第13个数字。</p><p>[译注：请注意区分此处所提到的校验位(parity bit)以及后面会经常提及的校验码(check digit)，在本文中，只需要将这个校验位理解为一种只由二进制编码模式(pattern)来区分(而不是&quot;计算&quot;)的信息，并且了解它只包含奇和偶两种取值即可，没必要深究&quot;哪一位是校验位&quot;。]</p><h2 id="introducing-arrays" tabindex="-1"><a class="header-anchor" href="#introducing-arrays"><span>引入数组</span></a></h2><p>在继续前，我们先来看看在本章接下来会用到的所有导入模块。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Array</span> <span class="token punctuation">(</span><span class="token constant">Array</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token hvariable">bounds</span><span class="token punctuation">,</span> <span class="token hvariable">elems</span><span class="token punctuation">,</span> <span class="token hvariable">indices</span><span class="token punctuation">,</span>
               		<span class="token hvariable">ixmap</span><span class="token punctuation">,</span> <span class="token hvariable">listArray</span><span class="token punctuation">)</span>

<span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Applicative</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;$&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Control<span class="token punctuation">.</span>Monad</span> <span class="token punctuation">(</span><span class="token hvariable">forM_</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Char</span> <span class="token punctuation">(</span><span class="token builtin">digitToInt</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Ix</span> <span class="token punctuation">(</span><span class="token constant">Ix</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>List</span> <span class="token punctuation">(</span><span class="token builtin">foldl</span>&#39;<span class="token punctuation">,</span> <span class="token builtin">group</span><span class="token punctuation">,</span> <span class="token builtin">sort</span><span class="token punctuation">,</span> <span class="token hvariable">sortBy</span><span class="token punctuation">,</span> <span class="token hvariable">tails</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Maybe</span> <span class="token punctuation">(</span><span class="token hvariable">catMaybes</span><span class="token punctuation">,</span> <span class="token hvariable">listToMaybe</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Ratio</span> <span class="token punctuation">(</span><span class="token constant">Ratio</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Word</span> <span class="token punctuation">(</span><span class="token constant">Word8</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> System<span class="token punctuation">.</span>Environment</span> <span class="token punctuation">(</span><span class="token hvariable">getArgs</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> <span class="token keyword">qualified</span> Data<span class="token punctuation">.</span>ByteString<span class="token punctuation">.</span>Lazy<span class="token punctuation">.</span>Char8 <span class="token keyword">as</span> L</span>
<span class="token import-statement"><span class="token keyword">import</span> <span class="token keyword">qualified</span> Data<span class="token punctuation">.</span>Map <span class="token keyword">as</span> M</span>

<span class="token import-statement"><span class="token keyword">import</span> Parse</span>                    <span class="token comment">-- from chapter 11</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>条形码的编码过程基本上可以采用表驱动的形式实现，即采用保存了位模式的小规模对照表来决定如何为每个数字进行编码。Haskell中的基本数据类型------列表和元组------都不太适合构造这种可能涉及随机访问的表。列表需要靠线性遍历才能访问到第 <em>k</em> 个元素。元组没有这个问题，但是Haskell的类型系统使我们很难编写一个接受元组和偏量，返回该元组内指定偏移元素的函数。(我们会在下面的练习中探究为什么这很难。)</p><p>说起常见的支持常数时间随机访问的数据结构，数组(array)自然首当其冲。Haskell提供了多种数组数据类型，我们可以利用它们将编码表表示为字符串构成的数组。</p><p>最简单的数组类型位于 <code>Data.Array</code> 模块，它正是我们要此处要用到的类型。该类型可以表示由任何Haskell类型的值构成的数组。与普通的Haskell类型一样，该类型的数组都是不可变的。不可变的数组的值只能在它被创建的时候填充一次，之后它的内容就无法被修改了。(标准库也提供了其他的数组类型，其中有一部分是可变的，但我们暂时还不会涉及到它们。)</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>

<span class="token hvariable">leftOddList</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;0001101&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0011001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0010011&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0111101&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0100011&quot;</span><span class="token punctuation">,</span>
               <span class="token string">&quot;0110001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0101111&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0111011&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0110111&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0001011&quot;</span><span class="token punctuation">]</span>

<span class="token hvariable">rightList</span> <span class="token operator">=</span> <span class="token builtin">map</span> <span class="token hvariable">complement</span> <span class="token operator">&lt;$&gt;</span> <span class="token hvariable">leftOddList</span>
	<span class="token keyword">where</span> <span class="token hvariable">complement</span> <span class="token char string">&#39;0&#39;</span> <span class="token operator">=</span> <span class="token char string">&#39;1&#39;</span>
      	<span class="token hvariable">complement</span> <span class="token char string">&#39;1&#39;</span> <span class="token operator">=</span> <span class="token char string">&#39;0&#39;</span>

<span class="token hvariable">leftEvenList</span> <span class="token operator">=</span> <span class="token builtin">map</span> <span class="token builtin">reverse</span> <span class="token hvariable">rightList</span>

<span class="token hvariable">parityList</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;111111&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;110100&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;110010&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;110001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;101100&quot;</span><span class="token punctuation">,</span>
          	<span class="token string">&quot;100110&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;100011&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;101010&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;101001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;100101&quot;</span><span class="token punctuation">]</span>

<span class="token hvariable">listToArray</span> <span class="token operator">::</span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token constant">Array</span> <span class="token constant">Int</span> <span class="token hvariable">a</span>
<span class="token hvariable">listToArray</span> <span class="token hvariable">xs</span> <span class="token operator">=</span> <span class="token hvariable">listArray</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token hvariable">l</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token hvariable">xs</span>
	<span class="token keyword">where</span> <span class="token hvariable">l</span> <span class="token operator">=</span> <span class="token builtin">length</span> <span class="token hvariable">xs</span>

<span class="token hvariable">leftOddCodes</span><span class="token punctuation">,</span> <span class="token hvariable">leftEvenCodes</span><span class="token punctuation">,</span> <span class="token hvariable">rightCodes</span><span class="token punctuation">,</span> <span class="token hvariable">parityCodes</span> <span class="token operator">::</span> <span class="token constant">Array</span> <span class="token constant">Int</span> <span class="token constant">String</span>

<span class="token hvariable">leftOddCodes</span> <span class="token operator">=</span> <span class="token hvariable">listToArray</span> <span class="token hvariable">leftOddList</span>
<span class="token hvariable">leftEvenCodes</span> <span class="token operator">=</span> <span class="token hvariable">listToArray</span> <span class="token hvariable">leftEvenList</span>
<span class="token hvariable">rightCodes</span> <span class="token operator">=</span> <span class="token hvariable">listToArray</span> <span class="token hvariable">rightList</span>
<span class="token hvariable">parityCodes</span> <span class="token operator">=</span> <span class="token hvariable">listToArray</span> <span class="token hvariable">parityList</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>[译注：强烈建议读者在继续阅读前参考本地址中关于EAN-13条码二进制编码算法的介绍。如果你已经看过上面的内容，我们也稍微展开说明一下：从代码中给出的rightList和leftEvenList的计算过程可以发现，即使同一数字有多种编码形式，但他们之间还是有规律可循的。从上面地址中记录了三种数字编码的表中可以看出，每个数字无论采用哪种二进制编码，最终都会被编码为由四个颜色交错的条纹表示的形式，正因如此，每个数字虽然只有10种取值却需要7位二进制才能表示(因为像0001111、0101010这种序列都是不符合&quot;四个条纹&quot;要求的)。而从Structure of EAN-13表格中可以看出，左侧分组中第一个数字都采用奇校验编码，而每个采用奇编码的数字编码，其第一个条纹都是白色的(以二进制&quot;0&quot;开头)；右侧分组中的数字编码的第一个条纹都是黑色的(以二进制&quot;1&quot;开头)。有了这些规律，条形码的分析过程可以被大大简化。上述事实在原文中没有给出，因此读者最好能留有印象，会有助于理解之后的一些内容。]</p><p><code>Data.Array</code> 模块中的 <code>listArray</code> 函数使用列表来填充数组。第一个参数是数组的边界，第二个参数是用来填充数组的列表。</p><p>数组有一个独特的性质，它的类型由它所包含数据的类型以及索引的类型共同决定。举例来说，<code>String</code> 组成的一维数组的类型为 <code>Array Int String</code> ，而二维 <code>String</code> 数组的类型则是 <code>Array (Int, Int) String</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> :m +Data.Array
ghci<span class="token operator">&gt;</span> :type listArray
listArray :: <span class="token punctuation">(</span>Ix i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>i, i<span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token punctuation">[</span>e<span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Array i e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建数组很简单。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> listArray <span class="token punctuation">(</span><span class="token number">0,2</span><span class="token punctuation">)</span> <span class="token string">&quot;foo&quot;</span>
array <span class="token punctuation">(</span><span class="token number">0,2</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">&#39;f&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">&#39;o&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">&#39;o&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>注意，我们必须在构造数组时显式指定数组的边界。数组边界是闭区间，所以一个边界为0和2的数组包含3个元素。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> listArray <span class="token punctuation">(</span><span class="token number">0,3</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>True,False,False,True,False<span class="token punctuation">]</span>
array <span class="token punctuation">(</span><span class="token number">0,3</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span>,True<span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">1</span>,False<span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">2</span>,False<span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">3</span>,True<span class="token punctuation">)</span><span class="token punctuation">]</span>
ghci<span class="token operator">&gt;</span> listArray <span class="token punctuation">(</span><span class="token number">0,10</span><span class="token punctuation">)</span> <span class="token string">&quot;too short&quot;</span>
array <span class="token punctuation">(</span><span class="token number">0,10</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">&#39;t&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">&#39;o&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">&#39;o&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">&#39; &#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">4</span>,<span class="token string">&#39;s&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">5</span>,<span class="token string">&#39;h&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">6</span>,<span class="token string">&#39;o&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">7</span>,<span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">8</span>,<span class="token string">&#39;t&#39;</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">9</span>,*** Exception: <span class="token punctuation">(</span>Array.<span class="token operator">!</span><span class="token punctuation">)</span>: undefined array element
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数组构造完成后，我们就可以借助(!)运算符通过索引访问元素了。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> a <span class="token operator">=</span> listArray <span class="token punctuation">(</span><span class="token number">0,14</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token number">2</span>
<span class="token string">&#39;c&#39;</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token number">100</span>
*** Exception: Error <span class="token keyword">in</span> array index
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于数组构造函数允许我们随意指定数组的边界，因此我们就没必要像C程序员一样只能用从0开始的索引值了。我们可以用任何便于操作的值当作数组的边界。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> a <span class="token operator">=</span> listArray <span class="token punctuation">(</span>-9,5<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token punctuation">(</span>-2<span class="token punctuation">)</span>
<span class="token string">&#39;h&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>索引值的类型可以为 <code>Ix</code> 类型的任意成员。也就是说我们就可以用像 <code>Char</code> 这种类型作为数组的索引类型。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> a <span class="token operator">=</span> listArray <span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span>, <span class="token string">&#39;h&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">97</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token string">&#39;e&#39;</span>
<span class="token number">101</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如需创建多维数组，可以用 <code>Ix</code> 实例组成的元组来作为数组的索引类型。<code>Prelude</code> 模块将拥有5个及5个以下元素的元组都定义为了 <code>Ix</code> 的成员。下面是一个3维数组的例子：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> a <span class="token operator">=</span> listArray <span class="token variable"><span class="token punctuation">((</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">))</span></span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token punctuation">]</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token punctuation">(</span><span class="token number">4,3</span>,7<span class="token punctuation">)</span>
<span class="token number">437</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="arrays-and-laziness" tabindex="-1"><a class="header-anchor" href="#arrays-and-laziness"><span>数组与惰性</span></a></h3><p>填充数组的列表包含的元素数目至少要与数组容量相等。如果列表中没有提供足够多的元素，那么程序在运行时就可能发生错误。这个错误发生的时机取决于数组的性质。</p><p>我们这里用到的数组类型对数组的元素采用了非严格求值。如果我们想用一个包含三个元素的列表填充一个多于三个元素的数组，那么其余的元素将是未定义的。但是只有我们试图访问超过第三个元素的时候才会发生错误。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>ghci<span class="token operator">&gt;</span> <span class="token builtin class-name">let</span> a <span class="token operator">=</span> listArray <span class="token punctuation">(</span><span class="token number">0,5</span><span class="token punctuation">)</span> <span class="token string">&quot;bar&quot;</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token number">2</span>
<span class="token string">&#39;r&#39;</span>
ghci<span class="token operator">&gt;</span> a <span class="token operator">!</span> <span class="token number">4</span>
*** Exception: <span class="token punctuation">(</span>Array.<span class="token operator">!</span><span class="token punctuation">)</span>: undefined array element
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Haskell也提供了严格求值的数组，它们会在上述场景中会有不同的行为。我们将在&quot;拆箱，抬举，和bottom&quot;一章中讨论两种数组之间的取舍。</p><h3 id="folding-over-arrays" tabindex="-1"><a class="header-anchor" href="#folding-over-arrays"><span>数组的折叠</span></a></h3><p><code>bounds</code> 函数返回在创建数组时用来指定边界的元组。 <code>indices</code> 函数返回数组中各个索引值组成的列表。我们可以用它们来定义实用的折叠函数，因为 <code>Data.Array</code> 模块本身并没有提供用于数组的折叠函数。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token comment">-- | Strict left fold, similar to foldl&#39; on lists.</span>
<span class="token hvariable">foldA</span> <span class="token operator">::</span> <span class="token constant">Ix</span> <span class="token hvariable">k</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token hvariable">b</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token constant">Array</span> <span class="token hvariable">k</span> <span class="token hvariable">b</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span>
<span class="token hvariable">foldA</span> <span class="token hvariable">f</span> <span class="token hvariable">s</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token hvariable">go</span> <span class="token hvariable">s</span> <span class="token punctuation">(</span><span class="token hvariable">indices</span> <span class="token hvariable">a</span><span class="token punctuation">)</span>
	<span class="token keyword">where</span> <span class="token hvariable">go</span> <span class="token hvariable">s</span> <span class="token punctuation">(</span><span class="token hvariable">j</span><span class="token operator">:</span><span class="token hvariable">js</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">let</span> <span class="token hvariable">s&#39;</span> <span class="token operator">=</span> <span class="token hvariable">f</span> <span class="token hvariable">s</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">!</span> <span class="token hvariable">j</span><span class="token punctuation">)</span>
                    	<span class="token keyword">in</span> <span class="token hvariable">s&#39;</span> <span class="token operator">`seq`</span> <span class="token hvariable">go</span> <span class="token hvariable">s&#39;</span> <span class="token hvariable">js</span>
      	<span class="token hvariable">go</span> <span class="token hvariable">s</span> <span class="token hvariable">_</span> <span class="token operator">=</span> <span class="token hvariable">s</span>

<span class="token comment">-- | Strict left fold using the first element of the array as its</span>
<span class="token comment">-- starting value, similar to foldl1 on lists.</span>
<span class="token hvariable">foldA1</span> <span class="token operator">::</span> <span class="token constant">Ix</span> <span class="token hvariable">k</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token constant">Array</span> <span class="token hvariable">k</span> <span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token hvariable">a</span>
<span class="token hvariable">foldA1</span> <span class="token hvariable">f</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token hvariable">foldA</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">!</span> <span class="token builtin">fst</span> <span class="token punctuation">(</span><span class="token hvariable">bounds</span> <span class="token hvariable">a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token hvariable">a</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可能很好奇为什么数组模块不预置像折叠函数这么有用的东西。我们会发现一维数组和列表之间有一些明显的相似性。例如，都只有两种自然的方式来折叠他们：从左向右折叠或者从右向左折叠。此外，每次都只能折叠一个元素。</p><p>上述这些相似性对于二维数组就已经不再成立了。首先，在二维数组上有意义的折叠方式有很多种。我们也许仍然想要逐个元素地进行折叠，但是对二维数组，还可以逐行折叠或者逐列折叠。其次，就算同样是逐个元素折叠，在二维数组中也不再是只有两种遍历方式了。</p><p>换句话讲，对于二维数组来说，有意义操作组合太多了，可也没什么足够的理由选取其中一部分添加到标准库。这个问题只存在于多维数组，所以最好还是让开发人员自己编写合适的折叠函数。从上面的例子也可以看出，这其实没什么难度。</p><h3 id="modifying-array-elements" tabindex="-1"><a class="header-anchor" href="#modifying-array-elements"><span>修改数组元素</span></a></h3><p>尽管存在用来&quot;修改&quot;不可变数组的函数，但其实都不怎么实用。以 <code>accum</code> 函数为例，它接受一个数组和一个由 <code>(索引，元素值)</code> 值对构成的列表，返回一个新数组，其中所有在指定索引位置的元素都被替换为指定的元素值。</p><p>由于数组是不可变的，所以哪怕只是修改一个元素，也需要拷贝整个数组。哪怕对于中等规模的数组，这种性能开销也可能很快变得难以承受。</p><p>Data.Array.Diff模块中的另一个数组类型DiffArray，尝试通过保存数组的连续版本之间的变化量来减少小规模修改造成的开销。遗憾的是，在编写本书的时候它的实现还不是很高效，对于实际应用来说，它还是太慢了。</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>不要失望</p><p>事实上，在Haskell中高效地修改数组是 <em>可能</em> 的------使用 <code>ST</code> monad即可。我们以后会在第二十六章中讨论这个话题。</p></div><h3 id="习题" tabindex="-1"><a class="header-anchor" href="#习题"><span>习题</span></a></h3><p>让我们简单的探索一下用元组替代数组的可行性</p><ol><li>编写一个函数，它接受如下两个参数：一个由4个元素组成的元组，一个整数。整数参数为0的时候，该函数应返回元组中最左侧的元素。整数参数为1的时候，返回后一个元素，依此类推。为了使该函数能通过类型检查，你需要对参数的类型做怎样的限制？</li><li>写一个与上面类似的函数，第一个参数改为6个元素组成的元组。</li><li>尝试重构上面的两个函数，让它们共用尽可能多的代码。你能找到多少可以共用的代码？</li></ol><h2 id="encoding-an-ean-13-barcode" tabindex="-1"><a class="header-anchor" href="#encoding-an-ean-13-barcode"><span>生成EAN-13条形码</span></a></h2><p>尽管我们的目标是对条形码进行 <em>解码</em> ，但要是能有一个编码器做参考还是很方便的。这样我们就可以检查 <code>decode . encode</code> 的输出是否与输入相同，以此来验证代码的逻辑是否正确。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token hvariable">encodeEAN13</span> <span class="token operator">::</span> <span class="token constant">String</span> <span class="token operator">-&gt;</span> <span class="token constant">String</span>
<span class="token hvariable">encodeEAN13</span> <span class="token operator">=</span> <span class="token builtin">concat</span> <span class="token operator">.</span> <span class="token hvariable">encodeDigits</span> <span class="token operator">.</span> <span class="token builtin">map</span> <span class="token builtin">digitToInt</span>

<span class="token comment">-- | This function computes the check digit; don&#39;t pass one in.</span>
<span class="token hvariable">encodeDigits</span> <span class="token operator">::</span> <span class="token punctuation">[</span><span class="token constant">Int</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token constant">String</span><span class="token punctuation">]</span>
<span class="token hvariable">encodeDigits</span> <span class="token hvariable">s</span><span class="token operator">@</span><span class="token punctuation">(</span><span class="token hvariable">first</span><span class="token operator">:</span><span class="token hvariable">rest</span><span class="token punctuation">)</span> <span class="token operator">=</span>
	<span class="token hvariable">outerGuard</span> <span class="token operator">:</span> <span class="token hvariable">lefties</span> <span class="token operator">++</span> <span class="token hvariable">centerGuard</span> <span class="token operator">:</span> <span class="token hvariable">righties</span> <span class="token operator">++</span> <span class="token punctuation">[</span><span class="token hvariable">outerGuard</span><span class="token punctuation">]</span>
			<span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token hvariable">left</span><span class="token punctuation">,</span> <span class="token hvariable">right</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">splitAt</span> <span class="token number">6</span> <span class="token hvariable">rest</span>
    <span class="token hvariable">lefties</span> <span class="token operator">=</span> <span class="token builtin">zipWith</span> <span class="token hvariable">leftEncode</span> <span class="token punctuation">(</span><span class="token hvariable">parityCodes</span> <span class="token operator">!</span> <span class="token hvariable">first</span><span class="token punctuation">)</span> <span class="token hvariable">left</span>
    <span class="token hvariable">righties</span> <span class="token operator">=</span> <span class="token builtin">map</span> <span class="token hvariable">rightEncode</span> <span class="token punctuation">(</span><span class="token hvariable">right</span> <span class="token operator">++</span> <span class="token punctuation">[</span><span class="token hvariable">checkDigit</span> <span class="token hvariable">s</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token hvariable">leftEncode</span> <span class="token operator">::</span> <span class="token constant">Char</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">String</span>
<span class="token hvariable">leftEncode</span> <span class="token char string">&#39;1&#39;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">leftOddCodes</span> <span class="token operator">!</span><span class="token punctuation">)</span>
<span class="token hvariable">leftEncode</span> <span class="token char string">&#39;0&#39;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">leftEvenCodes</span> <span class="token operator">!</span><span class="token punctuation">)</span>

<span class="token hvariable">rightEncode</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">String</span>
<span class="token hvariable">rightEncode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">rightCodes</span> <span class="token operator">!</span><span class="token punctuation">)</span>

<span class="token hvariable">outerGuard</span> <span class="token operator">=</span> <span class="token string">&quot;101&quot;</span>
<span class="token hvariable">centerGuard</span> <span class="token operator">=</span> <span class="token string">&quot;01010&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>[译注：上面的代码中&quot;where (left, right) = splitAt 6 rest&quot;，在原文中写为了&quot;where (left, right) = splitAt 5 rest&quot;，这是错误的，因为左侧分组有最后一个数字会被分到右侧分组中。]</p><p>输入编码器的字符串包含12个数字， <code>encodeDigits</code> 函数会添加第13位数字，即校验码。</p><p>[译注：这里所指的&quot;编码器&quot;指的是 <code>encodeEAN13</code> 函数。]</p><p>条形码的编码分为两组，每组各6个数字，两个分组的中间和&quot;外侧&quot;各有一个保护序列。现在里面的两组共12个数字已经编码好了，那么剩下的那一个数字哪儿去了？</p><p>左侧分组中的每个数字都使用奇校验(odd parity)或偶校验(even parity)进行编码，具体使用的编码方式取决于数字串中的第一个数字的二进制表示。如果第一个数字中某一位为0，则左侧分组中对应位置的数字采用偶数校验编码；如果该位为1，则该对应数字采用奇校验编码。这是一种优雅的设计，它使EAN-13条形码可以向前兼容老式的UPC-A标准。</p><p>::: {#constraints-on-our-decoder} :::</p><h2 id="对解码器的约束" tabindex="-1"><a class="header-anchor" href="#对解码器的约束"><span>对解码器的约束</span></a></h2><p>在讨论如何解码之前，我们先对可处理的条形码图片的种类做一些实际约束。</p><p>手机镜头和电脑摄像头通常会生成JPEG图像，但要写一个JPEG的解码器又要花上好几章的篇幅，因此我们将图片的解析工作简化为只需要处理netpbm文件格式。为此，我们会用到第十章中开发的解析组合子。</p><p>我们希望这个解码器能处理用低端手机上那种劣质的定焦镜头拍摄出来的图像。这些图像往往丢焦严重、噪点多、对比度低，分辨率也很低。万幸，解决这些问题的代码并不难写。我们已经实际验证过本章中的代码，保证它能够识别用货真价实的中低端摄像头拍摄出的实体书上的条形码。</p><p>我们会绕过所有的涉及复杂的图像处理的内容，因为那又是一个需要整章篇幅来介绍的课题。我们不会去校正拍摄角度，也不会去锐化那些由于拍摄距离过近导致较窄的条纹模糊不清，或者是拍摄距离过远导致相邻的条纹都糊到一起的图像。</p><figure><img src="/assets/ch12-bad-angled-YWbSKWPx.jpg" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><figure><img src="/assets/ch12-bad-too-near-BoTUpdKQ.jpg" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><figure><img src="data:image/jpeg;base64,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" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>[译注：上面三幅图分别展示了非正对条形码拍摄、拍摄距离过近、拍摄距离过远的情况]</p><h2 id="divide-and-conquer" tabindex="-1"><a class="header-anchor" href="#divide-and-conquer"><span>分而治之</span></a></h2><p>我们的任务是从摄像头拍摄的图像中提取出有效的条形码。这个描述不是特别明确，我们很难以此规划如何一步步展开行动。然而，我们可以先把一个大问题拆分为一系列的独立且易处理的子问题，随后再逐个击破。</p><ul><li>将颜色数据转换为易于我们处理的形式。</li><li>从图像中取单一扫描线，并根据该扫描线猜测这一行可能是哪些数字的编码。</li><li>根据上面的猜测，生成一系列有效解码结果。</li></ul><p>我们接下来会看到，上述的子问题中有些还可以进一步分解。</p><p>在编写本章给出的代码时你可能会问，这种分而治之的实现方式与最终方案的吻合程度有多高呢？答案是------我们远不是什么图像处理的专家，因此在开始撰写这一章的时候我们也不是很确定最终的解决方案会是什么样子。</p><p>关于到底什么样的方案才是可行的，我们事先也做了一些合理的猜测，最后就得到了上面给出的子任务列表。接下来我们就可以开始着手于那些知道如何解决的部分，而在空闲时考虑那些我们没有实际经验的内容。我们当时肯定是不知道有什么既存的算法可用，也没有提前做过什么总体规划。</p><p>像这样分解问题有两大优点。首先，通过在熟悉的领域开展实施，可以让人产生&quot;已经开始切实解决问题&quot;的积极情绪，哪怕现在做的以后不见得用得上也是一样。其次，在处理某个子问题时，我们可能会发现可以将它进一步分解为多个我们熟悉解决思路的子问题。我们可以继续专注于其中简单的部分，而把那些还没来得及彻底想通的部分延后，一个一个的处理上面子问题列表中的项。最后，等我们把不熟悉的和未解决的问题都搞定了，对最终的解决方案也就能心中有数了。</p><h2 id="turning-a-colour-image-into-something-tractable" tabindex="-1"><a class="header-anchor" href="#turning-a-colour-image-into-something-tractable"><span>将彩色图像转换为更容易处理的形式</span></a></h2><p>这个解码器处理的对象是条形码，条形码的本质就是连续的黑白条纹序列，而我们还想让这个解码器尽可能的简单，那么最容易处理的表示形式就是黑白图像------它的每个像素都是非黑即白的。</p><p>[译注：原文此处提到的图像是monochrome image(单色图像)，其中monochrome(单色的)一词虽然经常被当作black and white或grayscale的同义词使用(在图像领域)，但实际上这个词表达比了&quot;黑白&quot;更广泛的颜色范围，单色图像可选的颜色并不限于黑和白，例如夜视设备生成的图像，它同样是一种单色图像，但是它生成的图像通常采用绿色为前景色。换句话说，黑白图像只是单色图像的一种。详情参见英文维基词条 <em>monochrome</em> 。由于本章节中对图像的处理的确是要将图像处理为只有黑白两种颜色像素的图像(也确实不该考虑其他的颜色组合)，因此本章中的monochrome image都译为黑白图像。]</p><h3 id="parsing-a-colour-image" tabindex="-1"><a class="header-anchor" href="#parsing-a-colour-image"><span>分析彩色图像</span></a></h3><p>我们之前说过，我们的解码器将只支持netpbm图像。netpbm彩色图像格式只稍微比第十章中处理的灰度图像格式复杂一点点。其头部的识别串为&quot;P6&quot;,头部的其余部分都和灰度格式完全一样。在图像文件的主体部分，每个像素都由3个字节表示，分别对应红、绿、蓝3个颜色分量。</p><p>我们将图像数据表示为像素构成的二维数组。为了帮我们积累数组的使用经验，此处将完全采用数组实现。但实际上对于这个应用来说，我们用&quot;列表的列表&quot;代替数组也可以。因为数组在这里的优势不明显，它的唯一的好处就是很方便取整行。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token keyword">type</span> <span class="token constant">Pixel</span> <span class="token operator">=</span> <span class="token constant">Word8</span>
<span class="token keyword">type</span> <span class="token constant">RGB</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">Pixel</span><span class="token punctuation">,</span> <span class="token constant">Pixel</span><span class="token punctuation">,</span> <span class="token constant">Pixel</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token constant">Pixmap</span> <span class="token operator">=</span> <span class="token constant">Array</span> <span class="token punctuation">(</span><span class="token constant">Int</span><span class="token punctuation">,</span><span class="token constant">Int</span><span class="token punctuation">)</span> <span class="token constant">RGB</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们定义了一些类型的同义词来提高类型签名的可读性。</p><p>Haskell为数组提供了相当高的自由度，我们必须维数组选择一种合适的表示形式。这里我们将采取保守的方案，并遵守一个普遍的约定：索引值从0开始。我们不需要显式的存储图像的尺寸，因为用 <code>bounds</code> 函数可以从数组直接提取尺寸。</p><p>最终的解析器实现相当的简短，这都多亏了我们在第十章中开发的组合子。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token hvariable">parseRawPPM</span> <span class="token operator">::</span> <span class="token constant">Parse</span> <span class="token constant">Pixmap</span>
<span class="token hvariable">parseRawPPM</span> <span class="token operator">=</span>
    <span class="token hvariable">parseWhileWith</span> <span class="token hvariable">w2c</span> <span class="token punctuation">(</span><span class="token operator">/=</span> <span class="token char string">&#39;\n&#39;</span><span class="token punctuation">)</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">header</span> <span class="token operator">-&gt;</span> <span class="token hvariable">skipSpaces</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">assert</span> <span class="token punctuation">(</span><span class="token hvariable">header</span> <span class="token operator">==</span> <span class="token string">&quot;P6&quot;</span><span class="token punctuation">)</span> <span class="token string">&quot;invalid raw header&quot;</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">parseNat</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">width</span> <span class="token operator">-&gt;</span> <span class="token hvariable">skipSpaces</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">parseNat</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">height</span> <span class="token operator">-&gt;</span> <span class="token hvariable">skipSpaces</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">parseNat</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">maxValue</span> <span class="token operator">-&gt;</span>
    <span class="token hvariable">assert</span> <span class="token punctuation">(</span><span class="token hvariable">maxValue</span> <span class="token operator">==</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token string">&quot;max value out of spec&quot;</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">parseByte</span> <span class="token operator">==&gt;&amp;</span>
    <span class="token hvariable">parseTimes</span> <span class="token punctuation">(</span><span class="token hvariable">width</span> <span class="token operator">*</span> <span class="token hvariable">height</span><span class="token punctuation">)</span> <span class="token hvariable">parseRGB</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">pxs</span> <span class="token operator">-&gt;</span>
    <span class="token hvariable">identity</span> <span class="token punctuation">(</span><span class="token hvariable">listArray</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token hvariable">width</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token hvariable">height</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token hvariable">pxs</span><span class="token punctuation">)</span>

<span class="token hvariable">parseRGB</span> <span class="token operator">::</span> <span class="token constant">Parse</span> <span class="token constant">RGB</span>
<span class="token hvariable">parseRGB</span> <span class="token operator">=</span> <span class="token hvariable">parseByte</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">r</span> <span class="token operator">-&gt;</span>
        <span class="token hvariable">parseByte</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">g</span> <span class="token operator">-&gt;</span>
        <span class="token hvariable">parseByte</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">b</span> <span class="token operator">-&gt;</span>
        <span class="token hvariable">identity</span> <span class="token punctuation">(</span><span class="token hvariable">r</span><span class="token punctuation">,</span><span class="token hvariable">g</span><span class="token punctuation">,</span><span class="token hvariable">b</span><span class="token punctuation">)</span>

<span class="token hvariable">parseTimes</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Parse</span> <span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token constant">Parse</span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span>
<span class="token hvariable">parseTimes</span> <span class="token number">0</span> <span class="token hvariable">_</span> <span class="token operator">=</span> <span class="token hvariable">identity</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token hvariable">parseTimes</span> <span class="token hvariable">n</span> <span class="token hvariable">p</span> <span class="token operator">=</span> <span class="token hvariable">p</span> <span class="token operator">==&gt;</span> <span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token hvariable">x</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">&lt;$&gt;</span> <span class="token hvariable">parseTimes</span> <span class="token punctuation">(</span><span class="token hvariable">n</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token hvariable">p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码中唯一需要注意的是 <code>parseTimes</code> 函数，它会将一个分析器调用指定的次数，最后构造出一个分析结果组成的列表。</p><h3 id="greyscale-conversion" tabindex="-1"><a class="header-anchor" href="#greyscale-conversion"><span>灰度转换</span></a></h3><p>我们需要将彩色图像的色彩数据转换为黑白的形式。其中一个步骤是将色彩数据转换为灰度数据。有一个简单并广泛应用的公式[^1] 可以将彩色图像转换为灰度图像，该公式基于每个色彩通道的相对亮度来计算灰度信息。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token hvariable">luminance</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Pixel</span><span class="token punctuation">,</span> <span class="token constant">Pixel</span><span class="token punctuation">,</span> <span class="token constant">Pixel</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token constant">Pixel</span>
<span class="token hvariable">luminance</span> <span class="token punctuation">(</span><span class="token hvariable">r</span><span class="token punctuation">,</span><span class="token hvariable">g</span><span class="token punctuation">,</span><span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">round</span> <span class="token punctuation">(</span><span class="token hvariable">r&#39;</span> <span class="token operator">*</span> <span class="token number">0.30</span> <span class="token operator">+</span> <span class="token hvariable">g&#39;</span> <span class="token operator">*</span> <span class="token number">0.59</span> <span class="token operator">+</span> <span class="token hvariable">b&#39;</span> <span class="token operator">*</span> <span class="token number">0.11</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token hvariable">r&#39;</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span> <span class="token hvariable">r</span>
          <span class="token hvariable">g&#39;</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span> <span class="token hvariable">g</span>
          <span class="token hvariable">b&#39;</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span> <span class="token hvariable">b</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Haskell中的数组都是 <code>Functor</code> 类型类的成员，所以我们可以直接用 <code>fmap</code> 函数一次性将整张图片或者单行扫描线从彩色格式转为灰度格式。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token keyword">type</span> <span class="token constant">Greymap</span> <span class="token operator">=</span> <span class="token constant">Array</span> <span class="token punctuation">(</span><span class="token constant">Int</span><span class="token punctuation">,</span><span class="token constant">Int</span><span class="token punctuation">)</span> <span class="token constant">Pixel</span>

<span class="token hvariable">pixmapToGreymap</span> <span class="token operator">::</span> <span class="token constant">Pixmap</span> <span class="token operator">-&gt;</span> <span class="token constant">Greymap</span>
<span class="token hvariable">pixmapToGreymap</span> <span class="token operator">=</span> <span class="token builtin">fmap</span> <span class="token hvariable">luminance</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面给出来的 <code>pixmapToGreymap</code> 函数只是拿来举个例子，因为我们只需要检查图片的部分行来提取可能存在的条形码，也就没必要在以后用不到的数据上做多余的转换工作了。</p><h3 id="greyscale-to-binary-and-type-safety" tabindex="-1"><a class="header-anchor" href="#greyscale-to-binary-and-type-safety"><span>灰度二值化和类型安全</span></a></h3><p>接下来要处理的子问题是如何将灰度图像转换为二值图像，二值图像的每个像素都只处于&quot;打开&quot;或&quot;关闭&quot;两种状态之一。</p><p>..FIXME: 此处的digit做value译 .. FIXME: 本段里的bit应该是指pixel</p><p>在一个图像处理程序中通常需要同时处理大量的数值，有时为了方便，可能会把同一种数值类型用于不同的目的。例如，我们只要约定数字1表示一个像素处于&quot;打开&quot;状态，而0表示一个像素处于&quot;关闭&quot;状态，就可以直接使用 <code>Pixel</code> 类型表示像素的开/关状态了。</p><p>然而，这种做法有潜在的迷惑性。如果想知道某个特定的 <code>Pixel</code> 类型的值究竟是代表一个数值还是一个&quot;开&quot;/&quot;关&quot;状态，就不能靠类型签名轻易确定了。在某些场景中，我们可能很轻易的就使用了错误类型的数值，而且编译器也不会检查到错误，因为这个值的类型与签名指定的类型是吻合的。</p><p>我们可以尝试通过引入类型别名来解决这个问题。和前文中把 <code>Pixel</code> 声明为 <code>Word8</code> 的别名一样，我们也可以把 <code>Bit</code> 类型声明为 <code>Pixel</code> 类型的别名。这么做虽然可能提高一定的可读性，但类型别名还是不会让编译器替我们做什么有用的工作。</p><p>编译器将把Pixel和Bit当做完全相同的类型，所以就算把 <code>Pixel</code> 类型的值253传给一个接受Bit类型的值(0或1)的函数，编译器也不会报错。</p><p>如果另外定义一个单色(monochrome)类型，编译器就会阻止我们像上述的例子那样意外混用不同类型。</p><div class="language-haskell line-numbers-mode" data-ext="haskell" data-title="haskell"><pre class="language-haskell"><code><span class="token comment">-- file: ch12/Barcode.hs</span>
<span class="token keyword">data</span> <span class="token constant">Bit</span> <span class="token operator">=</span> <span class="token constant">Zero</span> <span class="token operator">|</span> <span class="token constant">One</span>
           <span class="token keyword">deriving</span> <span class="token punctuation">(</span><span class="token constant">Eq</span><span class="token punctuation">,</span> <span class="token constant">Show</span><span class="token punctuation">)</span>

<span class="token hvariable">threshold</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Ix</span> <span class="token hvariable">k</span><span class="token punctuation">,</span> <span class="token constant">Integral</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Array</span> <span class="token hvariable">k</span> <span class="token hvariable">a</span> <span class="token operator">-&gt;</span> <span class="token constant">Array</span> <span class="token hvariable">k</span> <span class="token constant">Bit</span>
<span class="token hvariable">threshold</span> <span class="token hvariable">n</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token hvariable">binary</span> <span class="token operator">&lt;$&gt;</span> <span class="token hvariable">a</span>
    <span class="token keyword">where</span> <span class="token hvariable">binary</span> <span class="token hvariable">i</span> <span class="token operator">|</span> <span class="token hvariable">i</span> <span class="token operator">&lt;</span> <span class="token hvariable">pivot</span>  <span class="token operator">=</span> <span class="token constant">Zero</span>
                    <span class="token operator">|</span> <span class="token builtin">otherwise</span>  <span class="token operator">=</span> <span class="token constant">One</span>
          <span class="token hvariable">pivot</span>    <span class="token operator">=</span> <span class="token builtin">round</span> <span class="token operator">$</span> <span class="token hvariable">least</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token hvariable">greatest</span> <span class="token operator">-</span> <span class="token hvariable">least</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token hvariable">n</span>
          <span class="token hvariable">least</span>    <span class="token operator">=</span> <span class="token builtin">fromIntegral</span> <span class="token operator">$</span> <span class="token hvariable">choose</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">)</span> <span class="token hvariable">a</span>
          <span class="token hvariable">greatest</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span> <span class="token operator">$</span> <span class="token hvariable">choose</span> <span class="token punctuation">(</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token hvariable">a</span>
          <span class="token hvariable">choose</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token hvariable">foldA1</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">-&gt;</span> <span class="token keyword">if</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token keyword">then</span> <span class="token hvariable">x</span> <span class="token keyword">else</span> <span class="token hvariable">y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>threshold</code> 函数会先计算输入数组中的最大值和最小值，结合参数提供的一个介于0到1之间的阈值，求出一个&quot;枢轴&quot;(pivot)值。对于数组中的每个元素，如果该元素的值小于这个枢轴值，则计算结果为 <code>Zero</code> ，否则结果为 <code>One</code> 。注意到这里我们用到了一个在 <code class="interpreted-text" role="ref">folding-over-arrays</code> 一节中编写的折叠函数。</p><p>[译注：针对这段代码，需要指出一个关于RGB颜色模式的注意点。在前面我们通过 <code>luminance</code> 函数将要给彩色图片中的像素中的三个颜色分量转换为了一个灰度值，这个灰度值可以理解为&quot;当一个RGB颜色的三个分量同时取该值的时候该像素的颜色&quot;。在这个定义下，纯白色的灰度值为255，随着灰度值越来越小，这个颜色将会呈现为越来越深的灰色，直到灰度值为0，此时该像素为纯黑色。可见这里有一个比较反直觉的地方，即&quot;灰度值越大，颜色越浅&quot;。这个特征反映到二值化函数 <code>threshold</code> 的返回值中就是&quot;深色的像素返回值为 <code>Zero</code> ，浅色的像素返回值为 <code>One</code> &quot;。]</p><h2 id="what-have-we-done-to-our-image" tabindex="-1"><a class="header-anchor" href="#what-have-we-done-to-our-image"><span>我们对图像做了哪些处理？</span></a></h2><p>让我们暂时回过头来想一想，在我们把图像从彩色转换为黑白的过程中，到底对它做了哪些处理。下面是一张用VGA分辨率的摄像头捕获的图像。我们做的就是把这个图像&quot;压缩&quot;到只剩下足够识别条形码的内容。</p><figure><img src="/assets/ch12-barcode-photo-TKRw7KMk.jpg" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>这之中编码的数字序列，9780132114677，被打印在了条形码的下方。左侧分组编码了数字串780132，第一位数字9也被隐含在该组每个数字编码的奇偶性中。右侧分组编码了数字串114677，其中最后一个7为校验码。下面是这个条形码的清晰版本，是我们在一个提供免费条形码图片生成服务的网站得到的。</p><p>[译注：本段中所说的&quot;奇偶性&quot;指的是&quot;左侧分组中的某个数字是采用的奇校验编码还是偶校验编码&quot;，为了避免啰嗦，在后文中都会采用这个说法；本章中并没有涉及自然数中&quot;奇偶性&quot;的概念，请注意与之区分。]</p><figure><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASQAAADrCAIAAABPUnxuAAAACXBIWXMAAAsSAAALEgHS3X78AAAAHXRFWHRTb2Z0d2FyZQBHTlUgR2hvc3RzY3JpcHQgNy4wN6zhIvkAAAVKSURBVHic7dvZbuJIAEBRGPX//zLzEA1CeKEw9jWZPucpInS5vFy8kL7ebrcLcLx/zp4A/C3EBhGxQURsEBEbRMQGEbFBRGwQERtExAYRsUFEbBARG0TEBhGxQURsEBEbRMQGEbFBRGwQERtExAYRsUFEbBARG0TEBhGxQURsEBEbRMQGEbFBRGwQERtExAYRsUFEbBARG0TEBhGxQURsEPlz9gTmXa/Xy+Vyu91mf340ff3nlaXR1sd//O10KdPfjo85Pp+lpYxsk5ERxt+5vs0/X+v1df98P34bZzaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggcr3dbmfPYcb1er1cLj9ze/z5b2abTP2ubeLMBhGxQeRPs5ifU/yjzaf76VBTT4MPLn125JfzvF7XLsXHx1xar20ban1W2955eXWp9nI7j++7DXt53VureZDDz2zX63V2w41szW1GdvD0xaX5rM9z22/Hl/5yER/+k7cG37Cy705+vId3S7ssH4qZY89s93V73DT3F7d92KyfRmZLm31xaen3Fz8MYHbdZ5e+/s5xBzU28k9WdvTjmo7vu7f28ku32+3xqFsf/zjFPdvTih20nuMH0HQCs8fKUnVvHanTZR364b3vO5+8vHrcvKObyc9+4peie7Ynj580uyg/rk7fZ7PGZ7Vh/rv3OR1833euz+d+yv1wtHedE9sRxi88lrby7CvHnQdevvNLDB6U0wcbR5zDd9lWZyVXxLZ0K7Xj+Eu/utfy9J74+N4W2DecNt86FqfX2yPPct+ayY76G7lj79lmb3t+7wXkXkYOwaUbodKG0m7/eXzx8/EP2svxjVx3Gbn5ucInm3h6yK4/ijzIW0tfuhLba5sc52mGwab+/m3y6PCnkU8fHvcXdxl8w/PowQ/dg6wv/emEdu7Rs9fTiPXxx2dyhKdv3o7e4NGZ7dDVWB9838cen1ta+jdcN9493cws/fbzqcaPRh6Vmf0452nkN9z6T+37IGfbo4VvKO1/r8/sxwl/QbL74Ec7en98YWnr31t8Ps+zriHPyuzHmU8jd/zOZMXTdfllbv8d99R0OsjSsN9T2rvW/9RmZb3Ka8j49mzWaU8jg7WdfpGyMoHdv5FbGnBp2PVvC7fNofe1Nwj3n0/cmMXTyMEX3zK4U5cWNDirD+e5tJRfFM+gt9a0v4b8mcbpW/78/+QDfwn/UxsiYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSJig4jYICI2iIgNImKDiNggIjaIiA0iYoOI2CAiNoiIDSL/ArxVeBHzJxoQAAAAAElFTkSuQmCC" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>我们从捕获的图像中选择了一个行。为了便于观察，我们将这一行垂直拉伸，然后把它放在&quot;完美图像&quot;的上方并且做了拉伸让两幅图像对齐。</p><figure><img src="/assets/ch12-barcode-example-DMEgrBs-.png" alt="image" tabindex="0" loading="lazy"><figcaption>image</figcaption></figure><p>图中用深灰色标出的是经过亮度转换处理的行。可以看到，这部分图像对比度低，清晰度也很差，有多处模糊和噪点。浅灰色标出的部分来自于同一行，但是对比度经过了调整。</p><p>更靠下的一小段的显示了对亮度转换过的行进行二值化后的效果。你会发现有些条纹变得更粗了而有些更细了，有些条纹还稍微左移或者右移了一点距离。</p><p>[译注：&quot;亮度转换&quot;即上面的 <code>luminance</code> 函数进行的处理，将彩色图像转换为灰度图像；&quot;二值化&quot;即上面的 <code>threshold</code> 函数进行的处理，将灰度图像中的像素进行二值化。]</p><p>可见，要在具有这些缺陷的图像中找出匹配结果显然不是随随便便就能做到的。我们必须让代码足够健壮以应对过粗、过细或者位置有偏差的条纹。而且条纹的宽度取决于摄像头与书的距离，我们也不能对它做任何假设。</p></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/学习/Haskell中文文档/12-1.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 61403802+hahg2000@users.noreply.github.com">hahg2000</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/11.html" aria-label="第 11 章：测试和质量保障"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->第 11 章：测试和质量保障</div></a><a class="route-link nav-link next" href="/%E5%AD%A6%E4%B9%A0/Haskell%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/13.html" aria-label="第 13 章：数据结构"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">第 13 章：数据结构<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 hahg </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Chw2KLnS.js" defer></script>
  </body>
</html>
